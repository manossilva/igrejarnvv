<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financeiro - Igreja</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Ícones Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- SheetJS para ler Excel/CSV -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <!-- PDF.js para extração de texto de PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>

    <style>
        :root {
            --apple-bg: #f5f5f7;
            --apple-card: #ffffff;
            --apple-text: #1d1d1f;
            --apple-text-secondary: #86868b;
            --apple-black: #000000;
            --apple-red: #ff3b30;
            --apple-green: #34c759;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--apple-bg);
            color: var(--apple-text);
            -webkit-font-smoothing: antialiased;
        }

        .apple-card {
            background-color: var(--apple-card);
            border-radius: 22px;
            box-shadow: 0 4px 14px rgba(0, 0, 0, 0.03), 0 1px 4px rgba(0, 0, 0, 0.02);
            padding: 24px;
        }

        .apple-card-small {
            background-color: var(--apple-card);
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            padding: 16px;
        }

        /* Scroll lateral dos meses */
        .month-scroll-container::-webkit-scrollbar {
            height: 4px;
        }
        .month-scroll-container::-webkit-scrollbar-thumb {
            background: #d1d1d6;
            border-radius: 10px;
        }
        .month-scroll-container {
            scrollbar-width: thin;
            scrollbar-color: #d1d1d6 transparent;
        }

        .tab-btn {
            white-space: nowrap;
            padding: 10px 22px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s ease;
            cursor: pointer;
            user-select: none;
        }

        .tab-active { 
            background-color: var(--apple-black); 
            color: #ffffff;
            transform: scale(1.02);
        }
        .tab-inactive { 
            background-color: #e8e8ed; 
            color: var(--apple-text); 
        }
        .tab-inactive:hover { 
            background-color: #d1d1d6; 
        }

        .divider { height: 24px; width: 2px; background-color: #d1d1d6; margin: 0 8px; border-radius: 2px; flex-shrink: 0; }
        
        #loading-overlay {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(4px);
        }

        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .editable-input {
            background: transparent;
            border-bottom: 2px solid transparent;
            transition: border-color 0.2s;
            width: 100%;
        }
        .editable-input:focus {
            outline: none;
            border-bottom-color: var(--apple-black);
        }
    </style>
</head>
<body class="pb-12">

    <!-- Overlay de Carregamento -->
    <div id="loading-overlay" class="fixed inset-0 z-[100] hidden flex items-center justify-center">
        <div class="flex flex-col items-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-black mb-4"></div>
            <p class="font-semibold text-sm">Processando documento...</p>
        </div>
    </div>

    <div class="max-w-4xl mx-auto px-4 sm:px-6 pt-10">
        
        <!-- Cabeçalho -->
        <header class="mb-6 flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold tracking-tight">Caixa da Igreja</h1>
                <p class="text-[#86868b] mt-1 text-sm font-medium">Relatório Financeiro Consolidado</p>
            </div>
            <div class="flex gap-3">
                <button onclick="toggleImport()" class="bg-[#e8e8ed] hover:bg-[#d1d1d6] text-black px-4 py-2 rounded-full font-semibold text-sm flex items-center gap-2 transition-colors">
                    <i data-lucide="file-up" class="w-4 h-4"></i>
                    Subir Arquivo
                </button>
                <div class="bg-black p-3 rounded-full text-white hidden sm:flex">
                    <i data-lucide="church" class="w-5 h-5"></i>
                </div>
            </div>
        </header>

        <!-- Painel de Importação Avançado -->
        <div id="import-panel" class="apple-card mb-8 hidden border-2 border-dashed border-gray-300">
            <h3 class="font-bold text-lg mb-2 flex items-center gap-2">
                <i data-lucide="table" class="w-5 h-5 text-gray-500"></i> Importar Documento (PDF/XLSX/CSV)
            </h3>
            <p class="text-sm text-gray-500 mb-4">Selecione seu arquivo. O sistema entende tabelas e textos automaticamente.</p>
            
            <div class="flex flex-col gap-4">
                <input type="file" id="xlsx-file" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-black file:text-white hover:file:bg-gray-800 cursor-pointer" accept=".xlsx, .xls, .csv, .pdf">
                
                <div class="text-xs text-gray-400 italic">Dica: Ao subir o PDF, os meses serão gerados abaixo.</div>
            </div>

            <div class="mt-4 flex justify-end gap-3">
                <button onclick="toggleImport()" class="px-4 py-2 rounded-xl text-sm font-semibold text-gray-600 hover:bg-gray-100">Cancelar</button>
                <button onclick="processarTudo()" class="bg-black text-white px-6 py-2 rounded-xl text-sm font-semibold hover:bg-gray-800">Processar Agora</button>
            </div>
        </div>

        <!-- Cards Globais (Editáveis) -->
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-8">
            <!-- Card Reserva -->
            <div class="apple-card flex flex-col justify-center border-2 border-transparent focus-within:border-black transition-all">
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center gap-2 text-[#86868b]">
                        <i data-lucide="shield-check" class="w-5 h-5"></i>
                        <span class="font-semibold text-sm uppercase tracking-wider text-xs">Reserva de Emergência</span>
                    </div>
                    <i data-lucide="edit-3" class="w-3 h-3 text-gray-300"></i>
                </div>
                <div class="flex items-baseline">
                    <span class="text-xl font-bold mr-1">R$</span>
                    <input type="number" id="input-reserva" step="0.01" class="text-2xl font-bold editable-input" value="0.00" onchange="atualizarValoresIniciais()">
                </div>
                <p class="text-[10px] text-gray-400 mt-1 uppercase tracking-tighter">Valor atual em mãos</p>
            </div>
            
            <!-- Card Caixa -->
            <div class="apple-card flex flex-col justify-center border-2 border-transparent focus-within:border-black transition-all">
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center gap-2 text-[#86868b]">
                        <i data-lucide="wallet" class="w-5 h-5"></i>
                        <span class="font-semibold text-sm uppercase tracking-wider text-xs">Saldo em Caixa</span>
                    </div>
                    <i data-lucide="edit-3" class="w-3 h-3 text-gray-300"></i>
                </div>
                <div class="flex items-baseline">
                    <span class="text-xl font-bold mr-1">R$</span>
                    <input type="number" id="input-caixa" step="0.01" class="text-2xl font-bold editable-input" value="0.00" onchange="atualizarValoresIniciais()">
                </div>
                <p class="text-[10px] text-gray-400 mt-1 uppercase tracking-tighter">Valor atual em mãos</p>
            </div>
        </div>

        <!-- Seletor de Período -->
        <div class="mb-6 overflow-hidden">
            <div class="flex gap-3 overflow-x-auto month-scroll-container pb-4 items-center" id="month-tabs">
                <p class="text-sm text-gray-400 italic px-4">Aguardando importação de dados...</p>
            </div>
        </div>

        <!-- Conteúdo -->
        <div id="month-content" class="hidden">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold" id="titulo-periodo">Resumo</h2>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="apple-card-small border-l-4 border-black">
                    <p class="text-xs text-[#86868b] font-semibold uppercase mb-1">Entradas</p>
                    <p class="text-xl font-bold text-black" id="mes-entradas">R$ 0,00</p>
                </div>
                <div class="apple-card-small border-l-4 border-[#86868b]">
                    <p class="text-xs text-[#86868b] font-semibold uppercase mb-1">Saídas</p>
                    <p class="text-xl font-bold text-black" id="mes-saidas">R$ 0,00</p>
                </div>
                <div class="apple-card-small bg-black text-white" id="card-saldo">
                    <p class="text-xs text-gray-300 font-semibold uppercase mb-1">Resultado do Mês</p>
                    <p class="text-xl font-bold" id="mes-saldo">R$ 0,00</p>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div class="apple-card flex flex-col items-center justify-center">
                    <h3 class="w-full text-left font-bold text-lg mb-6">Gasto por Categoria</h3>
                    <div class="relative w-full max-w-[250px] aspect-square">
                        <canvas id="expensesChart"></canvas>
                        <div id="no-data-msg" class="absolute inset-0 flex items-center justify-center hidden">
                            <p class="text-[#86868b] text-sm text-center">Sem dados de saída.</p>
                        </div>
                    </div>
                </div>
                <div class="apple-card">
                    <h3 class="font-bold text-lg mb-4">Detalhamento</h3>
                    <div id="categories-list" class="space-y-4 max-h-[300px] overflow-y-auto pr-2"></div>
                </div>
            </div>

            <div id="dia-a-dia-container" class="apple-card mb-6 hidden">
                <h3 class="font-bold text-lg mb-4 flex items-center gap-2"><i data-lucide="list"></i> Movimentações</h3>
                <div id="lista-transacoes" class="space-y-1"></div>
            </div>
        </div>
        
        <!-- Estado Vazio -->
        <div id="empty-state" class="py-20 text-center apple-card">
            <div class="bg-gray-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                <i data-lucide="file-text" class="text-gray-400"></i>
            </div>
            <h3 class="text-lg font-bold">Nenhum dado processado</h3>
            <p class="text-gray-500 text-sm max-w-xs mx-auto mt-2">Suba o seu PDF ou Excel de fechamento mensal para começar a visualizar o histórico e os gráficos.</p>
            <button onclick="toggleImport()" class="mt-6 bg-black text-white px-6 py-2 rounded-full text-sm font-semibold">Começar Agora</button>
        </div>
    </div>

    <!-- Modal Avisos -->
    <div id="msg-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center">
        <div class="bg-white rounded-2xl p-6 max-w-sm w-full mx-4 shadow-xl">
            <h3 class="text-xl font-bold mb-2" id="msg-title"></h3>
            <p class="text-gray-600 mb-6" id="msg-text"></p>
            <button onclick="closeMsgModal()" class="w-full bg-black text-white font-bold py-3 rounded-xl">Fechar</button>
        </div>
    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

        lucide.createIcons();

        const formatCurrency = (val) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(val);

        // Estado inicial zerado
        const churchData = {
            reservaInicialBase: 0.00,
            caixaInicialBase: 0.00,
            meses: [] // Memória limpa para começar do zero
        };

        let currentChart = null;
        let allViewOptions = [];

        function atualizarValoresIniciais() {
            const resInput = document.getElementById('input-reserva');
            const caxInput = document.getElementById('input-caixa');
            
            churchData.reservaInicialBase = parseFloat(resInput.value) || 0;
            churchData.caixaInicialBase = parseFloat(caxInput.value) || 0;
            
            // Re-renderiza se houver dados
            if (churchData.meses.length > 0) {
                renderizarInterface();
            }
        }

        function renderizarInterface() {
            generateViewOptions();
            renderTabs();
            // Seleciona a primeira aba disponível (ou a ativa se possível)
            if (allViewOptions.length > 0) {
                const activeTab = document.querySelector('.tab-active');
                const idToSelect = activeTab ? activeTab.id.replace('tab-btn-', '') : allViewOptions[0].id;
                selectTab(idToSelect);
                
                document.getElementById('empty-state').classList.add('hidden');
                document.getElementById('month-content').classList.remove('hidden');
            }
        }

        function generateViewOptions() {
            allViewOptions = [];
            
            // Meses Individuais
            churchData.meses.forEach(m => allViewOptions.push({ ...m, isGroup: false, titulo: `Resumo: ${m.nome}` }));
            
            // Consolidado total se houver mais de 1 mês
            if (churchData.meses.length > 1) {
                let ent = churchData.meses.reduce((a, b) => a + b.entradas, 0);
                let sai = churchData.meses.reduce((a, b) => a + b.saidas, 0);
                allViewOptions.push({ 
                    id: `consolidado-total`, 
                    nome: `Geral (Acumulado)`, 
                    entradas: ent, 
                    saidas: sai, 
                    isGroup: true, 
                    titulo: `Saldo Acumulado de ${churchData.meses.length} Meses`, 
                    detalhesSaidas: [{ categoria: "Total Despesas", valor: sai, icon: "list" }] 
                });
            }
        }

        function renderTabs() {
            const container = document.getElementById('month-tabs');
            container.innerHTML = '';
            let addedDivider = false;
            
            allViewOptions.forEach(tab => {
                if (tab.isGroup && !addedDivider) { 
                    const div = document.createElement('div');
                    div.className = 'divider';
                    container.appendChild(div);
                    addedDivider = true; 
                }
                
                let btn = document.createElement('div');
                btn.className = `tab-btn tab-inactive`;
                btn.id = `tab-btn-${tab.id}`;
                btn.innerText = tab.nome;
                btn.onclick = () => selectTab(tab.id);
                container.appendChild(btn);
            });
        }

        function selectTab(id) {
            document.querySelectorAll('.tab-btn').forEach(b => {
                b.classList.remove('tab-active');
                b.classList.add('tab-inactive');
            });
            
            const selectedBtn = document.getElementById(`tab-btn-${id}`);
            if (selectedBtn) {
                selectedBtn.classList.remove('tab-inactive');
                selectedBtn.classList.add('tab-active');
            }

            let data = allViewOptions.find(t => t.id === id);
            if(!data) return;

            document.getElementById('titulo-periodo').innerText = data.titulo;
            document.getElementById('mes-entradas').innerText = formatCurrency(data.entradas);
            document.getElementById('mes-saidas').innerText = formatCurrency(data.saidas);
            
            let saldo = data.entradas - data.saidas;
            let el = document.getElementById('mes-saldo');
            el.innerText = (saldo >= 0 ? '+ ' : '') + formatCurrency(saldo);
            el.className = `text-xl font-bold ${saldo < 0 ? 'text-[#ff3b30]' : 'text-white'}`;

            renderChartAndList(data.detalhesSaidas, data.saidas);
            renderDiaADia(data);
        }

        function renderChartAndList(detalhes, total) {
            let canvas = document.getElementById('expensesChart');
            let list = document.getElementById('categories-list');
            list.innerHTML = '';
            if(currentChart) currentChart.destroy();

            if(!detalhes || detalhes.length === 0 || total === 0) {
                canvas.style.display = 'none';
                document.getElementById('no-data-msg').classList.remove('hidden');
                return;
            }

            canvas.style.display = 'block';
            document.getElementById('no-data-msg').classList.add('hidden');

            currentChart = new Chart(canvas, {
                type: 'doughnut',
                data: {
                    labels: detalhes.map(d => d.categoria),
                    datasets: [{ data: detalhes.map(d => d.valor), backgroundColor: ['#000', '#333', '#666', '#999', '#CCC'], cutout: '70%' }]
                },
                options: { 
                    responsive: true,
                    plugins: { legend: { display: false } } 
                }
            });

            detalhes.forEach(item => {
                list.innerHTML += `
                    <div class="flex items-center justify-between p-3 rounded-xl bg-[#f5f5f7]">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-black flex items-center justify-center text-white"><i data-lucide="${item.icon || 'circle'}" class="w-4 h-4"></i></div>
                            <span class="font-semibold text-sm">${item.categoria}</span>
                        </div>
                        <span class="font-bold text-sm">${formatCurrency(item.valor)}</span>
                    </div>`;
            });
            lucide.createIcons();
        }

        function renderDiaADia(data) {
            let container = document.getElementById('dia-a-dia-container');
            let list = document.getElementById('lista-transacoes');
            if(data.isGroup || !data.transacoes || data.transacoes.length === 0) { container.classList.add('hidden'); return; }
            container.classList.remove('hidden');
            list.innerHTML = '';
            data.transacoes.forEach(t => {
                list.innerHTML += `
                    <div class="flex justify-between py-3 border-b border-gray-100">
                        <div class="flex gap-4">
                            <span class="text-xs font-bold text-gray-400 w-10">${t.data}</span>
                            <span class="text-sm font-semibold">${t.descricao}</span>
                        </div>
                        <span class="text-sm font-bold ${t.tipo === 'entrada' ? 'text-green-500' : ''}">${t.tipo === 'entrada' ? '+' : '-'} ${formatCurrency(t.valor)}</span>
                    </div>`;
            });
        }

        // --- LÓGICA DE IMPORTAÇÃO ---
        function toggleImport() { document.getElementById('import-panel').classList.toggle('hidden'); }
        function showMessage(t, m) { document.getElementById('msg-title').innerText = t; document.getElementById('msg-text').innerText = m; document.getElementById('msg-modal').classList.remove('hidden'); }
        function closeMsgModal() { document.getElementById('msg-modal').classList.add('hidden'); }

        async function processarTudo() {
            let fileInput = document.getElementById('xlsx-file');
            let file = fileInput.files[0];
            if (!file) { showMessage("Aviso", "Por favor, selecione um arquivo."); return; }

            document.getElementById('loading-overlay').classList.remove('hidden');

            try {
                if (file.type === 'application/pdf') {
                    await processarPDF(file);
                } else {
                    await processarExcel(file);
                }
            } catch (err) {
                showMessage("Erro", "Falha ao processar arquivo: " + err.message);
            } finally {
                document.getElementById('loading-overlay').classList.add('hidden');
                fileInput.value = '';
            }
        }

        async function processarExcel(file) {
            let reader = new FileReader();
            reader.onload = function(e) {
                let data = new Uint8Array(e.target.result);
                let workbook = XLSX.read(data, { type: 'array' });
                let sheet = workbook.Sheets[workbook.SheetNames[0]];
                let json = XLSX.utils.sheet_to_json(sheet);
                processarDadosEstruturados(json);
            };
            reader.readAsArrayBuffer(file);
        }

        async function processarPDF(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            let fullText = "";

            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const content = await page.getTextContent();
                const strings = content.items.map(item => item.str);
                fullText += strings.join(" ") + "\n";
            }

            const regex = /(JANEIRO|FEVEREIRO|MARÇO|ABRIL|MAIO|JUNHO|JULHO|AGOSTO|SETEMBRO|OUTUBRO|NOVEMBRO|DEZEMBRO)[\/\d]*\s+R\$\s*([\d\.,]+)\s+R\$\s*([\d\.,]+)/gi;
            let resultados = [];
            let match;
            while ((match = regex.exec(fullText)) !== null) {
                resultados.push({
                    'Mês': match[1],
                    '✅ Entradas (Receitas)': parseMoeda(match[2]),
                    '❌ Saídas (Despesas)': parseMoeda(match[3])
                });
            }

            if (resultados.length > 0) {
                processarDadosEstruturados(resultados);
            } else {
                throw new Error("Tabela de resumo não encontrada no PDF.");
            }
        }

        function parseMoeda(str) {
            if (typeof str === 'number') return str;
            if (!str) return 0;
            let val = str.replace(/\./g, '').replace(',', '.').replace(/[^0-9.-]/g, '');
            return parseFloat(val) || 0;
        }

        function identificarIdMes(str) {
            const s = str.toUpperCase();
            if (s.includes("JANEIRO")) return 1;
            if (s.includes("FEVEREIRO")) return 2;
            if (s.includes("MARÇO")) return 3;
            if (s.includes("ABRIL")) return 4;
            if (s.includes("MAIO")) return 5;
            if (s.includes("JUNHO")) return 6;
            if (s.includes("JULHO")) return 7;
            if (s.includes("AGOSTO")) return 8;
            if (s.includes("SETEMBRO")) return 9;
            if (s.includes("OUTUBRO")) return 10;
            if (s.includes("NOVEMBRO")) return 11;
            if (s.includes("DEZEMBRO")) return 12;
            return 99;
        }

        function processarDadosEstruturados(json) {
            json.forEach(row => {
                let mesRaw = row['Mês'] || row['mês'] || row['MES'];
                if (!mesRaw) return;

                let ent = parseMoeda(row['✅ Entradas (Receitas)'] || row['Entradas']);
                let sai = parseMoeda(row['❌ Saídas (Despesas)'] || row['Saídas']);
                
                let mesId = 'mes-' + identificarIdMes(mesRaw);
                let existente = churchData.meses.find(m => m.id === mesId);
                
                if (existente) {
                    existente.entradas = ent;
                    existente.saidas = sai;
                } else {
                    churchData.meses.push({ 
                        id: mesId, 
                        nome: mesRaw, 
                        entradas: ent, 
                        saidas: sai, 
                        transacoes: [], 
                        detalhesSaidas: [{ categoria: "Geral (Importado)", valor: sai, icon: "table" }] 
                    });
                }
            });

            // Ordena os meses por ID (considerando virada de ano simples 8-12 / 1-7)
            churchData.meses.sort((a, b) => {
                let idA = parseInt(a.id.replace('mes-', ''));
                let idB = parseInt(b.id.replace('mes-', ''));
                let scoreA = idA + (idA < 8 ? 12 : 0);
                let scoreB = idB + (idB < 8 ? 12 : 0);
                return scoreB - scoreA;
            });

            renderizarInterface();
            showMessage("Sucesso", "Dados importados e histórico gerado.");
            toggleImport();
        }

        // Inicialização básica
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            // Começa vazio
        });
    </script>
</body>
</html>
