<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financeiro - Igreja</title>
    
    <!-- Tailwind CSS para estilização rápida -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js para o gráfico -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Ícones Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Identidade Visual Estilo Apple */
        :root {
            --apple-bg: #f5f5f7;
            --apple-card: #ffffff;
            --apple-text: #1d1d1f;
            --apple-text-secondary: #86868b;
            --apple-black: #000000;
            --apple-red: #ff3b30;
            --apple-green: #34c759;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--apple-bg);
            color: var(--apple-text);
            -webkit-font-smoothing: antialiased;
        }

        .apple-card {
            background-color: var(--apple-card);
            border-radius: 22px;
            box-shadow: 0 4px 14px rgba(0, 0, 0, 0.03), 0 1px 4px rgba(0, 0, 0, 0.02);
            padding: 24px;
            transition: transform 0.2s ease;
        }

        .apple-card-small {
            background-color: var(--apple-card);
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            padding: 16px;
        }

        /* Esconder scrollbar na lista de meses */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .tab-btn {
            white-space: nowrap;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .tab-active {
            background-color: var(--apple-black);
            color: #ffffff;
        }

        .tab-inactive {
            background-color: #e8e8ed;
            color: var(--apple-text);
        }

        .tab-inactive:hover {
            background-color: #d1d1d6;
        }

        .divider {
            height: 24px;
            width: 2px;
            background-color: #d1d1d6;
            margin: 0 4px;
            border-radius: 2px;
        }

        /* Animação suave para painéis */
        .transition-height {
            transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out;
            overflow: hidden;
        }
    </style>
</head>
<body class="pb-12">

    <div class="max-w-3xl mx-auto px-4 sm:px-6 pt-10">
        
        <!-- Cabeçalho -->
        <header class="mb-6 flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold tracking-tight">Caixa da Igreja</h1>
                <p class="text-[#86868b] mt-1 text-sm font-medium">Relatório Financeiro Consolidado</p>
            </div>
            <div class="flex gap-3">
                <button onclick="toggleImport()" class="bg-[#e8e8ed] hover:bg-[#d1d1d6] text-black px-4 py-2 rounded-full font-semibold text-sm flex items-center gap-2 transition-colors">
                    <i data-lucide="upload" class="w-4 h-4"></i>
                    Importar Dados
                </button>
                <div class="bg-black p-3 rounded-full text-white hidden sm:flex">
                    <i data-lucide="church" class="w-5 h-5"></i>
                </div>
            </div>
        </header>

        <!-- Painel de Importação de Texto (Oculto por Padrão) -->
        <div id="import-panel" class="apple-card mb-8 hidden opacity-0 transition-opacity duration-300 border-2 border-dashed border-gray-300">
            <h3 class="font-bold text-lg mb-2 flex items-center gap-2">
                <i data-lucide="file-text" class="w-5 h-5 text-gray-500"></i> Importar Movimentações
            </h3>
            <p class="text-sm text-gray-500 mb-4">Cole o texto com as Entradas e Saídas do mês. O sistema irá ler as datas, valores e categorizar automaticamente.</p>
            <textarea id="import-text" class="w-full p-4 border rounded-xl text-sm bg-gray-50 focus:outline-none focus:ring-2 focus:ring-black" rows="6" placeholder="Exemplo:&#10;SAÍDAS DE FEVEREIRO:&#10;06/02 - R$ 69.90 - Mensalidade da Rádio&#10;&#10;ENTRADAS DE FEVEREIRO:&#10;08/02 - R$ 129.00 - Ofertas domingo"></textarea>
            <div class="mt-4 flex justify-end gap-3">
                <button onclick="toggleImport()" class="px-4 py-2 rounded-xl text-sm font-semibold text-gray-600 hover:bg-gray-100 transition-colors">Cancelar</button>
                <button onclick="processarTextoUpload()" class="bg-black text-white px-6 py-2 rounded-xl text-sm font-semibold hover:bg-gray-800 transition-colors">Processar Texto</button>
            </div>
        </div>

        <!-- Cards Globais (Reserva e Caixa Atual) -->
        <div class="grid grid-cols-2 gap-4 mb-8">
            <div class="apple-card flex flex-col justify-center">
                <div class="flex items-center gap-2 mb-2 text-[#86868b]">
                    <i data-lucide="shield-check" class="w-5 h-5"></i>
                    <span class="font-semibold text-sm uppercase tracking-wider">Fundo de Reserva</span>
                </div>
                <h2 class="text-2xl sm:text-3xl font-bold" id="val-reserva">R$ 0,00</h2>
            </div>
            
            <div class="apple-card flex flex-col justify-center">
                <div class="flex items-center gap-2 mb-2 text-[#86868b]">
                    <i data-lucide="wallet" class="w-5 h-5"></i>
                    <span class="font-semibold text-sm uppercase tracking-wider">Em Caixa (Atual)</span>
                </div>
                <h2 class="text-2xl sm:text-3xl font-bold" id="val-caixa">R$ 0,00</h2>
            </div>
        </div>

        <!-- Seletor de Meses e Períodos -->
        <div class="mb-6">
            <h3 class="text-sm font-semibold text-[#86868b] mb-3 uppercase tracking-wider">Filtrar Período</h3>
            <div class="flex gap-3 overflow-x-auto no-scrollbar pb-2 items-center" id="month-tabs">
                <!-- Abas geradas via JavaScript -->
            </div>
        </div>

        <!-- Conteúdo do Mês/Período Selecionado -->
        <div id="month-content" class="animate-fade-in">
            
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold" id="titulo-periodo">Resumo do Período</h2>
            </div>

            <!-- Resumo Entradas/Saídas do Mês -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="apple-card-small border-l-4 border-black">
                    <p class="text-xs text-[#86868b] font-semibold uppercase mb-1">Entradas (No período)</p>
                    <p class="text-xl font-bold text-black" id="mes-entradas">R$ 0,00</p>
                </div>
                <div class="apple-card-small border-l-4 border-[#86868b]">
                    <p class="text-xs text-[#86868b] font-semibold uppercase mb-1">Saídas (No período)</p>
                    <p class="text-xl font-bold text-black" id="mes-saidas">R$ 0,00</p>
                </div>
                <div class="apple-card-small bg-black text-white transition-colors duration-300" id="card-saldo">
                    <p class="text-xs text-gray-300 font-semibold uppercase mb-1" id="label-saldo">Resultado do Período</p>
                    <p class="text-xl font-bold" id="mes-saldo">R$ 0,00</p>
                </div>
            </div>

            <!-- Gráfico e Detalhamento -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <!-- Gráfico -->
                <div class="apple-card flex flex-col items-center justify-center">
                    <h3 class="w-full text-left font-bold text-lg mb-6">Onde foi gasto?</h3>
                    <div class="relative w-full max-w-[250px] aspect-square">
                        <canvas id="expensesChart"></canvas>
                        
                        <!-- Mensagem quando não há dados -->
                        <div id="no-data-msg" class="absolute inset-0 flex items-center justify-center hidden">
                            <p class="text-[#86868b] text-sm text-center">Sem dados de saída<br>neste período.</p>
                        </div>
                    </div>
                </div>

                <!-- Lista de Categorias -->
                <div class="apple-card">
                    <h3 class="font-bold text-lg mb-4">Categorias</h3>
                    <div id="categories-list" class="space-y-4 max-h-[300px] overflow-y-auto pr-2">
                        <!-- Lista gerada via JS -->
                    </div>
                </div>
            </div>

            <!-- Movimentações do Dia a Dia -->
            <div id="dia-a-dia-container" class="apple-card mb-6 hidden">
                <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
                    <i data-lucide="list" class="w-5 h-5 text-gray-500"></i> Movimentações (Dia a Dia)
                </h3>
                <div id="lista-transacoes" class="space-y-1">
                    <!-- Gerado via JS -->
                </div>
            </div>

            <!-- Anexo de Extrato -->
            <div id="extrato-container" class="apple-card mb-6 hidden">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-lg flex items-center gap-2">
                        <i data-lucide="paperclip" class="w-5 h-5 text-gray-500"></i> Extrato Bancário
                    </h3>
                    <label class="cursor-pointer bg-gray-100 hover:bg-gray-200 text-black px-4 py-2 rounded-xl text-sm font-semibold transition-colors flex items-center gap-2">
                        <i data-lucide="plus" class="w-4 h-4"></i> Anexar
                        <input type="file" id="extrato-upload" class="hidden" accept="image/*,.pdf" onchange="uploadExtrato(event)">
                    </label>
                </div>
                <div id="extrato-preview" class="mt-4 hidden w-full border border-gray-200 rounded-xl overflow-hidden bg-gray-50 flex items-center justify-center min-h-[100px] p-4">
                    <!-- Imagem ou PDF gerado via JS -->
                </div>
            </div>

        </div>
    </div>

    <!-- Modal de Mensagem -->
    <div id="msg-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-2xl p-6 max-w-sm w-full mx-4 shadow-xl transform scale-95 transition-transform duration-300" id="msg-modal-content">
            <h3 class="text-xl font-bold mb-2" id="msg-title">Aviso</h3>
            <p class="text-gray-600 mb-6" id="msg-text">Mensagem...</p>
            <button onclick="closeMsgModal()" class="w-full bg-black text-white font-bold py-3 rounded-xl">Entendi</button>
        </div>
    </div>

    <script>
        // Inicializa os ícones
        lucide.createIcons();

        // Formatação de Moeda Brasileira
        const formatCurrency = (value) => {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(value);
        };

        // --- BANCO DE DADOS DA IGREJA ---
        const churchData = {
            reservaInicialBase: 1636.00, // Valor base no final do mês 08
            caixaInicialBase: 2091.39,   // Valor base no final do mês 08
            
            // Meses ordenados do mais recente para o mais antigo (para exibição UI)
            meses: [
                {
                    id: 'mes-2',
                    nome: "Fevereiro/2026",
                    entradas: 2363.95,
                    saidas: 1665.40,
                    transacoes: [],
                    extrato: null,
                    detalhesSaidas: [
                        { categoria: "Custos Fixos (Aluguel, Rádio...)", valor: 725.51, icon: "home" },
                        { categoria: "Pastoral, Missões & Ofertas", valor: 292.00, icon: "heart" },
                        { categoria: "Limpeza, Água & Diversos", valor: 289.00, icon: "droplet" },
                        { categoria: "Infra & Equipamentos", valor: 288.90, icon: "hammer" },
                        { categoria: "Alimentação & Eventos", valor: 69.99, icon: "coffee" }
                    ]
                },
                {
                    id: 'mes-1',
                    nome: "Janeiro/2026",
                    entradas: 3220.86,
                    saidas: 3920.63,
                    transacoes: [],
                    extrato: null,
                    detalhesSaidas: [
                        { categoria: "Pastoral, Missões & Ofertas", valor: 2430.00, icon: "heart" },
                        { categoria: "Custos Fixos (Aluguel, Rádio...)", valor: 716.53, icon: "home" },
                        { categoria: "Limpeza, Água & Diversos", valor: 342.22, icon: "droplet" },
                        { categoria: "Alimentação & Eventos", valor: 249.98, icon: "coffee" },
                        { categoria: "Infra & Equipamentos", valor: 181.90, icon: "hammer" }
                    ]
                },
                {
                    id: 'mes-12',
                    nome: "Dezembro/2025",
                    entradas: 3413.65,
                    saidas: 5879.71,
                    transacoes: [],
                    extrato: null,
                    detalhesSaidas: [
                        { categoria: "Pastoral, Missões & Ofertas", valor: 3939.00, icon: "heart" },
                        { categoria: "Custos Fixos (Aluguel, Rádio...)", valor: 885.95, icon: "home" },
                        { categoria: "Limpeza, Água & Diversos", valor: 651.35, icon: "droplet" },
                        { categoria: "Infra & Equipamentos", valor: 235.90, icon: "hammer" },
                        { categoria: "Alimentação & Eventos", valor: 167.51, icon: "coffee" }
                    ]
                }
            ]
        };

        let currentChart = null;
        let allViewOptions = [];

        // Inicialização
        document.addEventListener('DOMContentLoaded', () => {
            calcularSaldosGlobais();
            generateViewOptions();
            renderTabs();
            // Inicia mostrando o mês mais recente (Fev/2026)
            selectTab('mes-2');
        });

        // Função para calcular os saldos reais descontando da reserva
        function calcularSaldosGlobais() {
            let reservaAtual = churchData.reservaInicialBase;
            let caixaAtual = churchData.caixaInicialBase;

            // Ordenar meses do mais antigo pro mais novo para cálculo progressivo
            let mesesCalc = [...churchData.meses].reverse();

            mesesCalc.forEach(mes => {
                const saldo = mes.entradas - mes.saidas;
                
                if (saldo < 0) {
                    const deficit = Math.abs(saldo);
                    if (reservaAtual >= deficit) {
                        reservaAtual -= deficit;
                    } else {
                        const faltante = deficit - reservaAtual;
                        reservaAtual = 0; 
                        caixaAtual -= faltante;
                    }
                } else {
                    caixaAtual += saldo;
                }
            });

            // Atualiza UI
            document.getElementById('val-reserva').innerText = formatCurrency(reservaAtual);
            
            const valCaixaEl = document.getElementById('val-caixa');
            valCaixaEl.innerText = formatCurrency(caixaAtual);
            
            if (caixaAtual < 0) {
                valCaixaEl.classList.add('text-[#ff3b30]');
            } else {
                valCaixaEl.classList.remove('text-[#ff3b30]');
            }
        }

        // Gera os dados agrupados (2, 3, 4, 5, 6 meses)
        function generateViewOptions() {
            allViewOptions = [];

            // Adiciona Meses Individuais (na ordem original - do mais novo pro mais antigo)
            churchData.meses.forEach(m => {
                allViewOptions.push({
                    ...m,
                    titulo: `Resumo: ${m.nome}`,
                    isGroup: false
                });
            });

            // Gera Agrupamentos
            const groupedCounts = [2, 3, 4, 5];
            groupedCounts.forEach(count => {
                if(churchData.meses.length < count) return; // Só agrupa se houver meses suficientes

                const mesesAgrupar = churchData.meses.slice(0, count);
                let totalEntradas = 0;
                let totalSaidas = 0;
                let categoriasMap = {};

                mesesAgrupar.forEach(m => {
                    totalEntradas += m.entradas;
                    totalSaidas += m.saidas;
                    
                    m.detalhesSaidas.forEach(d => {
                        if (!categoriasMap[d.categoria]) {
                            categoriasMap[d.categoria] = { valor: 0, icon: d.icon };
                        }
                        categoriasMap[d.categoria].valor += d.valor;
                    });
                });

                let detalhesAgrupados = Object.keys(categoriasMap).map(k => ({
                    categoria: k,
                    valor: categoriasMap[k].valor,
                    icon: categoriasMap[k].icon
                }));
                detalhesAgrupados.sort((a, b) => b.valor - a.valor);

                allViewOptions.push({
                    id: `grupo-${count}`,
                    nome: `Últimos ${count} meses`,
                    titulo: `Resumo Consolidado: Últimos ${count} meses`,
                    entradas: totalEntradas,
                    saidas: totalSaidas,
                    detalhesSaidas: detalhesAgrupados,
                    isGroup: true
                });
            });
        }

        // Renderiza a barra de navegação
        function renderTabs() {
            const tabsContainer = document.getElementById('month-tabs');
            tabsContainer.innerHTML = '';

            let addedDivider = false;

            allViewOptions.forEach(tabData => {
                // Adiciona um divisor visual entre individuais e agrupados
                if (tabData.isGroup && !addedDivider) {
                    const divider = document.createElement('div');
                    divider.className = 'divider';
                    tabsContainer.appendChild(divider);
                    addedDivider = true;
                }

                const btn = document.createElement('div');
                btn.className = `tab-btn tab-inactive`;
                btn.innerText = tabData.nome;
                btn.id = `tab-btn-${tabData.id}`;
                btn.onclick = () => selectTab(tabData.id);
                tabsContainer.appendChild(btn);
            });
        }

        // Função ao clicar em uma aba
        function selectTab(id) {
            allViewOptions.forEach(tab => {
                const btn = document.getElementById(`tab-btn-${tab.id}`);
                if (btn) {
                    if (tab.id === id) {
                        btn.classList.remove('tab-inactive');
                        btn.classList.add('tab-active');
                    } else {
                        btn.classList.remove('tab-active');
                        btn.classList.add('tab-inactive');
                    }
                }
            });

            const activeData = allViewOptions.find(t => t.id === id);
            
            document.getElementById('titulo-periodo').innerText = activeData.titulo;
            document.getElementById('mes-entradas').innerText = formatCurrency(activeData.entradas);
            document.getElementById('mes-saidas').innerText = formatCurrency(activeData.saidas);
            
            const saldo = activeData.entradas - activeData.saidas;
            const saldoEl = document.getElementById('mes-saldo');
            
            saldoEl.innerText = formatCurrency(saldo);
            
            if (saldo < 0) {
                saldoEl.classList.remove('text-white');
                saldoEl.classList.add('text-[#ff453a]'); 
            } else {
                saldoEl.classList.add('text-white');
                saldoEl.classList.remove('text-[#ff453a]');
            }
            
            renderChartAndList(activeData.detalhesSaidas, activeData.saidas);
            renderDiaADia(activeData);
            renderExtrato(activeData);
        }

        function renderChartAndList(detalhes, totalSaidas) {
            const listContainer = document.getElementById('categories-list');
            listContainer.innerHTML = '';
            
            const noDataMsg = document.getElementById('no-data-msg');
            const canvasElement = document.getElementById('expensesChart');

            if (currentChart) {
                currentChart.destroy();
            }

            if (!detalhes || detalhes.length === 0 || totalSaidas === 0) {
                noDataMsg.classList.remove('hidden');
                canvasElement.style.display = 'none';
                listContainer.innerHTML = '<p class="text-[#86868b] text-sm text-center mt-6">Nenhuma movimentação registrada.</p>';
                return;
            }

            noDataMsg.classList.add('hidden');
            canvasElement.style.display = 'block';

            const labels = detalhes.map(d => d.categoria);
            const dataValues = detalhes.map(d => d.valor);
            
            const bgColors = ['#000000', '#333333', '#666666', '#999999', '#CCCCCC'];

            const ctx = canvasElement.getContext('2d');
            currentChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: dataValues,
                        backgroundColor: bgColors,
                        borderWidth: 2,
                        borderColor: '#ffffff',
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    cutout: '70%',
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) { label += ': '; }
                                    if (context.parsed !== null) {
                                        label += formatCurrency(context.parsed);
                                    }
                                    return label;
                                }
                            },
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            padding: 12,
                            cornerRadius: 8,
                            displayColors: false
                        }
                    }
                }
            });

            detalhes.forEach((item, index) => {
                const percent = totalSaidas > 0 ? ((item.valor / totalSaidas) * 100).toFixed(1) : 0;
                const dotColor = bgColors[index % bgColors.length];

                const itemDiv = document.createElement('div');
                itemDiv.className = "flex items-center justify-between p-3 rounded-xl bg-[#f5f5f7]";
                itemDiv.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full flex items-center justify-center text-white min-w-[32px]" style="background-color: ${dotColor}">
                            <i data-lucide="${item.icon}" class="w-4 h-4"></i>
                        </div>
                        <div>
                            <p class="font-semibold text-sm text-black leading-tight">${item.categoria}</p>
                            <p class="text-xs text-[#86868b]">${percent}% do total</p>
                        </div>
                    </div>
                    <div class="font-bold text-sm text-right min-w-[80px]">
                        ${formatCurrency(item.valor)}
                    </div>
                `;
                listContainer.appendChild(itemDiv);
            });

            lucide.createIcons();
        }

        // --- FUNCIONALIDADES NOVAS (Importador / Dia a Dia / Extrato) --- //

        // Modais (Alerts customizados)
        function showMessage(title, text) {
            const modal = document.getElementById('msg-modal');
            const content = document.getElementById('msg-modal-content');
            document.getElementById('msg-title').innerText = title;
            document.getElementById('msg-text').innerText = text;
            
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                content.classList.remove('scale-95');
            }, 10);
        }

        function closeMsgModal() {
            const modal = document.getElementById('msg-modal');
            const content = document.getElementById('msg-modal-content');
            modal.classList.add('opacity-0');
            content.classList.add('scale-95');
            setTimeout(() => { modal.classList.add('hidden'); }, 300);
        }

        function toggleImport() {
            const panel = document.getElementById('import-panel');
            if(panel.classList.contains('hidden')) {
                panel.classList.remove('hidden');
                setTimeout(() => panel.classList.remove('opacity-0'), 10);
            } else {
                panel.classList.add('opacity-0');
                setTimeout(() => panel.classList.add('hidden'), 300);
            }
        }

        function classificarCategoria(desc) {
            const d = desc.toLowerCase();
            if (d.includes('pastor') || d.includes('miss') || d.includes('oferta') || d.includes('dízimo') || d.includes('dizimo') || d.includes('prebenda')) return "Pastoral, Missões & Ofertas";
            if (d.includes('aluguel') || d.includes('rádio') || d.includes('radio') || d.includes('tarifa') || d.includes('internet') || d.includes('banco')) return "Custos Fixos (Aluguel, Rádio...)";
            if (d.includes('limpeza') || d.includes('água') || d.includes('agua') || d.includes('higiene') || d.includes('sulgipe') || d.includes('iguá') || d.includes('papel') || d.includes('detergente')) return "Limpeza, Água & Diversos";
            if (d.includes('lanche') || d.includes('café') || d.includes('cafe') || d.includes('bolo') || d.includes('refrigerante') || d.includes('pão') || d.includes('pães') || d.includes('comida') || d.includes('almoço')) return "Alimentação & Eventos";
            return "Infra & Equipamentos"; // Fallback genérico
        }

        function processarTextoUpload() {
            const text = document.getElementById('import-text').value;
            if(!text.trim()) { showMessage("Erro", "Cole o texto primeiro."); return; }

            let currentMode = null; 
            let currentMonthNum = null;
            let currentMonthName = "";
            let transacoesLidas = [];

            const lines = text.split('\n');
            const monthMap = { 'JANEIRO':1, 'FEVEREIRO':2, 'MARÇO':3, 'ABRIL':4, 'MAIO':5, 'JUNHO':6, 'JULHO':7, 'AGOSTO':8, 'SETEMBRO':9, 'OUTUBRO':10, 'NOVEMBRO':11, 'DEZEMBRO':12 };

            for(let line of lines) {
                line = line.trim();
                if(!line) continue;

                // Detecta Sessão e Mês
                if(line.toUpperCase().includes("ENTRADAS")) {
                    currentMode = 'entrada';
                    for(let m in monthMap) { if(line.toUpperCase().includes(m)) { currentMonthNum = monthMap[m]; currentMonthName = m; } }
                    continue;
                }
                if(line.toUpperCase().includes("SAÍDAS") || line.toUpperCase().includes("SAIDAS")) {
                    currentMode = 'saida';
                    for(let m in monthMap) { if(line.toUpperCase().includes(m)) { currentMonthNum = monthMap[m]; currentMonthName = m; } }
                    continue;
                }

                // Match: Data - R$ Valor - Descricao
                const regex = /^(\d{1,2}[\/\.]\d{1,2}(?:[\/\.]\d{2,4})?)\s*[:-]\s*R\$\s*([\d.,]+)\s*-\s*(.+)$/i;
                const match = line.match(regex);
                
                if(match && currentMode) {
                    const dataStr = match[1];
                    let valorStr = match[2];
                    
                    // Tratamento numérico (ex: 1.500,00 vs 69.90)
                    if (valorStr.includes(',') && valorStr.includes('.')) {
                        valorStr = valorStr.replace(/\./g, '').replace(',', '.');
                    } else if (valorStr.includes(',')) {
                        valorStr = valorStr.replace(',', '.');
                    } else if (valorStr.includes('.')) {
                        const parts = valorStr.split('.');
                        if(parts[1] && parts[1].length === 3) {
                            valorStr = valorStr.replace('.', ''); // Era milhar
                        }
                    }

                    const valor = parseFloat(valorStr);
                    const desc = match[3];

                    if(!currentMonthNum) {
                        const dateParts = dataStr.split(/[\/\.]/);
                        if(dateParts.length >= 2) currentMonthNum = parseInt(dateParts[1]);
                    }

                    transacoesLidas.push({
                        data: dataStr,
                        valor: valor,
                        descricao: desc,
                        tipo: currentMode,
                        categoria: currentMode === 'saida' ? classificarCategoria(desc) : "Entrada"
                    });
                }
            }

            if(transacoesLidas.length > 0 && currentMonthNum) {
                integrarNovosDados(currentMonthNum, currentMonthName || "Mês " + currentMonthNum, transacoesLidas);
                showMessage("Sucesso!", `Foram importadas ${transacoesLidas.length} movimentações para ${currentMonthName || "Mês " + currentMonthNum}.`);
                document.getElementById('import-text').value = '';
                toggleImport();
            } else {
                showMessage("Atenção", "Não foi possível identificar transações. Verifique se o formato está igual aos que você costuma colar (Ex: 01/01 - R$ 10.00 - Descrição).");
            }
        }

        function integrarNovosDados(mesId, mesName, transacoes) {
            let mesObj = churchData.meses.find(m => m.id === `mes-${mesId}`);
            
            if(!mesObj) {
                // Cria novo mês
                mesObj = {
                    id: `mes-${mesId}`,
                    nome: `${mesName.charAt(0).toUpperCase() + mesName.slice(1).toLowerCase()}`,
                    entradas: 0,
                    saidas: 0,
                    transacoes: [],
                    extrato: null,
                    detalhesSaidas: []
                };
                churchData.meses.unshift(mesObj); // Adiciona no inicio
                
                // Reordena (assumindo que id maior é mais recente. Nota: pode falhar entre anos, ideal seria ano-mes)
                churchData.meses.sort((a,b) => {
                    const aId = parseInt(a.id.replace('mes-',''));
                    const bId = parseInt(b.id.replace('mes-',''));
                    return bId - aId;
                });
            }

            // Junta as transações e recalcula
            mesObj.transacoes = [...(mesObj.transacoes || []), ...transacoes];
            
            mesObj.entradas = 0;
            mesObj.saidas = 0;
            let catMap = {};

            mesObj.transacoes.forEach(t => {
                if(t.tipo === 'entrada') mesObj.entradas += t.valor;
                if(t.tipo === 'saida') {
                    mesObj.saidas += t.valor;
                    if(!catMap[t.categoria]) catMap[t.categoria] = 0;
                    catMap[t.categoria] += t.valor;
                }
            });

            const iconMap = {
                "Pastoral, Missões & Ofertas": "heart",
                "Custos Fixos (Aluguel, Rádio...)": "home",
                "Limpeza, Água & Diversos": "droplet",
                "Alimentação & Eventos": "coffee",
                "Infra & Equipamentos": "hammer"
            };
            
            mesObj.detalhesSaidas = Object.keys(catMap).map(k => ({
                categoria: k,
                valor: catMap[k],
                icon: iconMap[k] || "circle"
            }));

            calcularSaldosGlobais();
            generateViewOptions();
            renderTabs();
            selectTab(`mes-${mesId}`);
        }

        // Renderização do Dia a Dia
        function renderDiaADia(activeData) {
            const container = document.getElementById('dia-a-dia-container');
            const lista = document.getElementById('lista-transacoes');
            
            if(activeData.isGroup || !activeData.transacoes || activeData.transacoes.length === 0) {
                container.classList.add('hidden');
                return;
            }
            
            container.classList.remove('hidden');
            lista.innerHTML = '';

            // Ordenar transações por data (simples)
            const transacoesOrdenadas = [...activeData.transacoes].sort((a,b) => {
                const dayA = parseInt(a.data.split(/[\/\.]/)[0]) || 0;
                const dayB = parseInt(b.data.split(/[\/\.]/)[0]) || 0;
                return dayA - dayB;
            });

            transacoesOrdenadas.forEach(t => {
                const isEntrada = t.tipo === 'entrada';
                const colorClass = isEntrada ? 'text-[var(--apple-green)]' : 'text-[var(--apple-text)]';
                const sign = isEntrada ? '+' : '-';

                lista.innerHTML += `
                    <div class="flex items-center justify-between py-3 border-b border-gray-100 last:border-0 hover:bg-gray-50 rounded-lg px-2 transition-colors">
                        <div class="flex gap-4 items-center">
                            <div class="bg-gray-100 text-gray-500 font-bold text-xs rounded-lg px-2 py-1 w-12 text-center shrink-0">
                                ${t.data}
                            </div>
                            <div>
                                <p class="font-semibold text-sm text-black">${t.descricao}</p>
                                ${!isEntrada ? `<p class="text-xs text-[#86868b]">${t.categoria}</p>` : ''}
                            </div>
                        </div>
                        <div class="font-bold text-sm ${colorClass} shrink-0">
                            ${sign} ${formatCurrency(t.valor)}
                        </div>
                    </div>
                `;
            });
        }

        // Upload e Renderização do Extrato Bancário
        function uploadExtrato(event) {
            const file = event.target.files[0];
            if(!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const currentTabId = document.querySelector('.tab-active').id.replace('tab-btn-', '');
                const mesObj = churchData.meses.find(m => m.id === currentTabId);
                if(mesObj) {
                    mesObj.extrato = { url: e.target.result, type: file.type };
                    renderExtrato(mesObj);
                    showMessage("Pronto!", "Comprovante/Extrato anexado com sucesso neste mês.");
                }
            };
            reader.readAsDataURL(file);
        }

        function renderExtrato(mesObj) {
            const preview = document.getElementById('extrato-preview');
            const container = document.getElementById('extrato-container');
            
            // Oculta área de extrato se for visão agrupada
            if(!mesObj || mesObj.isGroup) {
                container.classList.add('hidden');
                return;
            }
            
            container.classList.remove('hidden');

            if(mesObj.extrato) {
                preview.classList.remove('hidden');
                if(mesObj.extrato.type.startsWith('image/')) {
                    preview.innerHTML = `<img src="${mesObj.extrato.url}" class="max-w-full h-auto rounded-lg max-h-[500px] object-contain">`;
                } else if (mesObj.extrato.type === 'application/pdf') {
                    preview.innerHTML = `<iframe src="${mesObj.extrato.url}" class="w-full h-96 border-0 rounded-lg"></iframe>`;
                } else {
                    preview.innerHTML = `<p class="text-sm text-[var(--apple-green)] font-semibold flex items-center gap-2"><i data-lucide="check-circle" class="w-4 h-4"></i> Arquivo anexado.</p>`;
                    lucide.createIcons();
                }
            } else {
                preview.classList.add('hidden');
                preview.innerHTML = '';
            }
            document.getElementById('extrato-upload').value = ''; // Limpa input
        }

    </script>
</body>
</html>
